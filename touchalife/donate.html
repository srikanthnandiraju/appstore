<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <title>[Dontate to Touch-A-Life]</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.4.1/semantic.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.0/animate.min.css" />
    <style type="text/css" media="screen">
        body {
            background: linear-gradient(100deg, #009cde, #003087);
            margin: 0px;
            padding: 0px;
            overflow: hidden;
        }
        
        .flexy {
            display: flex;
            justify-content: center;
            align-items: center;
            /* background:#efefef; */
        }
        
        .screen-wrapper {
            position: absolute;
            margin: 0px;
            top: 0px;
            left: 0px;
            bottom: 0px;
            right: 0px;
            overflow: hidden;
            overflow-y: scroll;
            -webkit-overflow-scrolling: touch;
        }
        
        .segment {
            padding: 20px !important;
            border-radius: 5px !important;
            box-shadow: 0px 4px 30px rgba(0, 0, 0, 0.5) !important;
            text-align: center !important;
        }
        
        #paypal-button-container {
            /* margin-top: 100px; */
        }
    </style>
</head>

<body>
    <div class="flexy screen-wrapper">
        <div class="ui center aligned container segment">
            <h2 id="loading-msg">
                <div class="ui active centered inline loader"></div>
                Processing please wait...
            </h2>
            <div id="paypal-button-container"></div>
            <h2 id="confirm-para" style="text-align: center; display: none">
                Click on the button to checkout <br />Total donation amount
                <span class="label label-primary" id="total-price" style="font-weight: bold;">0.0</span
          >
        </h2>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://www.paypalobjects.com/api/checkout.js"></script>

    <script src="https://www.gstatic.com/firebasejs/6.5.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/6.5.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/6.5.0/firebase-firestore.js"></script>
    <script src="js/app.js" type="text/javascript"></script>
    <script src="js/datasource.js" type="text/javascript"></script>
    <script>
      function getUrlParams(prop) {
        var params = {};
        var search = decodeURIComponent(
          window.location.href.slice(window.location.href.indexOf("?") + 1)
        );
        var definitions = search.split("&");
        definitions.forEach(function(val, key) {
          var parts = val.split("=", 2);
          params[parts[0]] = parts[1];
        });
        return prop && prop in params ? params[prop] : params;
      }

      $(document).ready(function() {
        const TXNS_TABLE_NAME = "transactions";
        const DONATIONS_TABLE_NAME = "donations";
        // Read param and get all baskets
        var params = getUrlParams();

        async function processCartPayment() {
          var user_data = null;
          var donation_request_data = null;
          await App.db
            .collection("user_profile")
            .where("user_id", "==", params.user_id)
            .get()
            .then(snapshot => {
              snapshot.docs.map(function(documentSnapshot) {
                user_data = documentSnapshot.data();
              });
            });

          await App.db
            .collection("donation_requests")
            .where(
              firebase.firestore.FieldPath.documentId(),
              "==",
              params.request_id
            )
            .get()
            .then(snapshot => {
              snapshot.docs.map(function(documentSnapshot) {
                donation_request_data = documentSnapshot.data();
                console.log(JSON.stringify(donation_request_data));
              });
            });

          var items = [];
          var bal = 0;
          oneItem = {
            name: user_data.first_name + " " + user_data.last_name,
            description: params.notes,
            price: params.price,
            currency: "USD",
            quantity: params.qty
          };
          items.push(oneItem);
          bal = parseFloat(oneItem.price) * parseInt(oneItem.quantity);
          console.log(oneItem);

          // update to html
          $("#total-price").text("$" + params.price);
          $("#confirm-para").show();
          $("#loading-msg").hide();

          paypal.Button.render(
            {
              // Set your environment
              env: "sandbox", // sandbox | production
              // Specify the style of the button
              style: {
                label: "paypal",
                size: "responsive", // small | medium | large | responsive
                shape: "rect", // pill | rect
                color: "blue", // gold | blue | silver | black
                tagline: false
              },

              // PayPal Client IDs - replace with your own
              // Create a PayPal app: https://developer.paypal.com/developer/applications/create

              client: {
                sandbox:
                  "ATMbMdYS-siK6NjL1CIAdEGIvGuNJmQwXdBc1lkaAtEpogL9uqPyVBidnCbyn584-r-xeoRXVQchTlYl",
                production: "<insert production client id>"
              },

              payment: function(data, actions) {
                return actions.payment.create({
                  payment: {
                    transactions: [
                      {
                        amount: {
                          total: bal,
                          currency: "USD"
                        },
                        description: "Touch-A-Life contributions",
                        custom: "Donation for a cause",
                        item_list: {
                          items: items
                        }
                      }
                    ]
                  }
                });
              },

              onAuthorize: function(data, actions) {
                return actions.payment.execute().then(async function() {
                  // put this into firebase transactions table.
                  data.user_id = params.user_id;
                  data.request_id = params.request_id;
                  data.donor_notes = params.notes;
                  data.quantity = params.qty;
                  data.amount = params.price;
                  data.user_info = user_data;
                  data.donation_info = donation_request_data;
                  createEntry(TXNS_TABLE_NAME, data);
                  console.log(data);

                  // insert data in donations table
                  const donation_object = {
                    request_id: params.request_id,
                    user_id: params.user_id,
                    payment_id: data.paymentID,
                    donated_amount: params.price,
                    donated_quantity: params.qty,
                    category: donation_request_data.category,
                    category_type: donation_request_data.category_type,
                    size: donation_request_data.category_size,
                    donation_notes: params.notes,
                    user_name: user_data.first_name + " " + user_data.last_name,
                    status: "approved"
                  };
                  createEntry(DONATIONS_TABLE_NAME, donation_object);

                  await App.db
                    .collection("donation_requests")
                    .doc(params.request_id)
                    .update({
                      donated_amount: firebase.firestore.FieldValue.increment(
                        Number(params.price)
                      )
                    });

                  $("#confirm-para").html(
                    "Thanks for Donating on Touch-A-Life platform"
                  );
                  $("#paypal-button-container").hide();
                  // const cur_url = window.location.href;
                  // const arr_split = cur_url.split("/");
                  // window.location.href = arr_split[0] + "//" + arr_split[
                  //     2] + "/#/transactions";
                  // alert('redirecting');
                });
              }
            },
            "#paypal-button-container"
          );
        }

        processCartPayment();
      });
    </script>
  </body>
</html>