<style>
    #add-post-button {
        position: absolute;
        bottom: 10px;
        right: 10px;
    }
    
    #social-screen-wrapper {
        position: absolute;
        margin: 0px;
        /* border: 2px solid red; */
        top: 1px;
        left: 0px;
        bottom: 0px;
        right: 0px;
        overflow: hidden;
        overflow-y: scroll;
        -webkit-overflow-scrolling: touch;
    }
</style>

<div id="social-screen-wrapper">
    <div class="ui fluid container" id="fwrapper">
        <br>
        <div id="all-feeds-view" class="ui cards animated fadeIn" style="padding:30px 5px;"></div>
        <!-- <div id="new-feeds-view" class="ui two cards stackable"></div> -->
    </div>
</div>
<button class="circular ui icon button blue" id="add-post-button">
    <i class="icon plus"></i>
</button>

<div class="ui modal" id="new-feed-modal" style="background:white !important; ">
    <i class="close icon"></i>
    <div class="header">
        New Post
    </div>
    <div class="content">
        <div class="ui form tiny">
            <div class="field">
                <textarea rows="2" id="feed-text"></textarea>
            </div>
        </div>
    </div>
    <div class="actions">
        <!-- <div class="ui red basic cancel  button">
            <i class="remove icon"></i> Cancel
        </div> -->
        <div class="ui red basic  button">
            <i class="image icon"></i> Image
        </div>
        <div class="ui green button" id="create-post-button">
            <i class="checkmark icon"></i> Post
        </div>
    </div>
</div>

<template id="one-booth-template">
    {{#feeds}}

    <div class="ui fluid card raised" style="margin:15px;">
        <div class="image center aligned">
            <img src="{{image}}" width="100%">
        </div>
        <div class="content">
            <img class="left floated mini ui image" src="{{profile_icon}}">
            <div class="header">{{user_name}}</div>
            <div class="meta">
                <a>{{time_lapsed}}</a>
            </div>
            <div class="description">
                {{text}}
            </div>
        </div>

        <!-- <div class="extra content">
            <div class="left floated">
                <span style="color:#333"> #tags:</span> &nbsp;{{tags}}
            </div>
        </div> -->
    </div>

    {{/feeds}}
</template>

<script type="text/javascript" charset="utf-8">
    function renderFeeds(payload) {
        let template = $('#one-booth-template').html();
        let html = Mustache.to_html(template, {
            feeds: payload
        });
        return html;
    }

    function handleNoFeedData(sub_text) {
        $("#all-feeds-view").empty();
        $("#all-feeds-view").html(App.Utils.getMessageTemplate({
            icon_name: "list alternate outline red",
            main_text: "No Feeds found",
            sub_text: sub_text
        }));
    }

    // This will be called from the popup screen.
    App.Events.listen("show-new-feed", function (feed_object) {
        App.FullScreen.hide("");
        var newFeedAsArray = [];
        feed_object.time_lapsed = "moments ago";
        feed_object.profile_icon = App.Utils.getFLNImage(App.User.firstname, App.User.lastname);
        newFeedAsArray.push(feed_object);
        var newFeedUI = renderFeeds(newFeedAsArray);
        $('#all-feeds-view').prepend(newFeedUI);
    });

    $(function () {

        $('#add-post-button').off('click').on('click', function () {
            App.FullScreen.show("screens/feed-form.html");
        });

        if (isMobile.Android()) {
            document.getElementById('all-feeds-view').style.paddingLeft = "15px";
        };
        
        $.getJSON(App.apiURL + "/feeds", function (responseData) {

            if (!responseData.payload.data || responseData.payload.data.length < 1) {
                handleNoFeedData("");
                return;
            }

            App.Feeds.items = responseData.payload.data;
            for (var i = 0; i < App.Feeds.items.length; i++) {
                var oneFeed = App.Feeds.items[i];
                var time_lapsed = moment(oneFeed.created_at).fromNow();
                oneFeed.time_lapsed = time_lapsed;

                var user_fullname_string = oneFeed.user_name.split(" ");
                var flImage = App.Utils.getFLNImage(user_fullname_string[0], user_fullname_string[1]);

                oneFeed.profile_icon = flImage;
            }
            $('#all-feeds-view').html(renderFeeds(App.Feeds.items));

        }).fail(function (jqXHR) {
            handleNoFeedData("Unable to fetch feed Data");
            alert(
                "PayPal Corp Network access is required to use this app.\n\nOpen the F5 VPN app and enable the VPN connection to proceed.\n\n The F5 VPN app can be downloaded via AirWatch PayPal Enterprise app store"
            );
            App.offline_mode = true;
        });

    });
</script>